<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:behaviors="clr-namespace:ChepaMotos.Behaviors"
             xmlns:vm="clr-namespace:ChepaMotos.ViewModels"
             x:Class="ChepaMotos.Views.DeliveryInvoicePage"
             BackgroundColor="{StaticResource Background}"
             NavigationPage.HasNavigationBar="False">

    <Grid RowDefinitions="*,Auto">
        <!-- ═══════════════════════════════════════════════ -->
        <!-- SCROLLABLE BODY                                 -->
        <!-- ═══════════════════════════════════════════════ -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Spacing="0" Padding="0">

                <!-- ─── Shop header ─────────────────────── -->
                <VerticalStackLayout BackgroundColor="{StaticResource Surface}"
                                     Padding="24,18"
                                     Spacing="4"
                                     HorizontalOptions="Fill">
                    <Label Text="ALMACEN Y TALLER CHEPA MOTOS"
                           FontFamily="IBMPlexMonoSemiBold"
                           FontSize="15"
                           TextColor="{StaticResource TextPrimary}"
                           HorizontalTextAlignment="Center" />
                    <Label Text="Nit. 1.036.621.093-1 · Calle 2A No. 78A-29 Belén Rincón · Tel. (604)6030702"
                           FontFamily="IBMPlexMono"
                           FontSize="11"
                           TextColor="{StaticResource TextMuted}"
                           HorizontalTextAlignment="Center" />
                </VerticalStackLayout>

                <BoxView HeightRequest="1" Color="{StaticResource Border}" />

                <!-- ─── Fields: 2-column (Fecha | Comprador) ── -->
                <Grid ColumnDefinitions="*,*"
                      ColumnSpacing="14"
                      Padding="24,18">

                    <!-- Fecha (editable, defaults to today) -->
                    <VerticalStackLayout Grid.Column="0" Spacing="6">
                        <Label Text="Fecha"
                               FontFamily="IBMPlexSansMedium" FontSize="12"
                               TextColor="{StaticResource TextSecondary}" />
                        <Border StrokeShape="RoundRectangle 6"
                                Stroke="{StaticResource Border}"
                                StrokeThickness="1"
                                BackgroundColor="{StaticResource Surface}"
                                HeightRequest="38"
                                Padding="0">
                            <DatePicker x:Name="DeliveryDatePicker"
                                        Format="dd/MM/yyyy"
                                        FontFamily="IBMPlexMono"
                                        FontSize="13"
                                        TextColor="{StaticResource TextPrimary}"
                                        BackgroundColor="Transparent"
                                        MinimumDate="01/01/2024"
                                        MaximumDate="12/31/2030" />
                        </Border>
                    </VerticalStackLayout>

                    <!-- Comprador / Almacén -->
                    <VerticalStackLayout Grid.Column="1" Spacing="6">
                        <Label Text="Comprador / Almacén"
                               FontFamily="IBMPlexSansMedium" FontSize="12"
                               TextColor="{StaticResource TextSecondary}" />
                        <Border StrokeShape="RoundRectangle 6"
                                Stroke="{StaticResource Border}"
                                StrokeThickness="1"
                                BackgroundColor="{StaticResource Surface}"
                                HeightRequest="38"
                                Padding="0">
                            <Entry Placeholder="Ej. Talleres La 80"
                                   FontFamily="IBMPlexSans"
                                   FontSize="13"
                                   BackgroundColor="Transparent"
                                   PlaceholderColor="{StaticResource TextMuted}" />
                        </Border>
                    </VerticalStackLayout>
                </Grid>

                <BoxView HeightRequest="1" Color="{StaticResource Border}" />

                <!-- ═══════════════════════════════════════ -->
                <!-- ITEMS TABLE                             -->
                <!-- ═══════════════════════════════════════ -->
                <VerticalStackLayout Padding="24,14,24,0" Spacing="0">

                    <!-- Table header -->
                    <Grid ColumnDefinitions="54,*,100,100,36"
                          Padding="8,8"
                          BackgroundColor="{StaticResource Surface2}">
                        <Label Grid.Column="0" Text="Cant." Style="{StaticResource TableHeader}" HorizontalTextAlignment="Center" />
                        <Label Grid.Column="1" Text="Descripción" Style="{StaticResource TableHeader}" />
                        <Label Grid.Column="2" Text="Vr. Unit." Style="{StaticResource TableHeader}" HorizontalTextAlignment="End" />
                        <Label Grid.Column="3" Text="Subtotal" Style="{StaticResource TableHeader}" HorizontalTextAlignment="End" />
                        <Label Grid.Column="4" Text="" />
                    </Grid>

                    <!-- Dynamic item rows -->
                    <VerticalStackLayout x:Name="ItemsContainer"
                                         Spacing="0">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="vm:InvoiceItemRow">
                                <VerticalStackLayout Spacing="0">
                                    <Border Stroke="{StaticResource Border}"
                                            StrokeThickness="0"
                                            BackgroundColor="{StaticResource Surface}"
                                            Padding="0">
                                        <Grid ColumnDefinitions="54,*,100,100,36"
                                              Padding="4,4">
                                            <Border Grid.Column="0" StrokeShape="RoundRectangle 4" Stroke="{StaticResource Border}" StrokeThickness="1" BackgroundColor="{StaticResource Surface}" Padding="0">
                                                <Entry Text="{Binding Quantity, Mode=TwoWay}"
                                                       FontFamily="IBMPlexMono" FontSize="13"
                                                       HorizontalTextAlignment="Center"
                                                       Keyboard="Numeric"
                                                       BackgroundColor="Transparent" />
                                            </Border>
                                            <Border Grid.Column="1" StrokeShape="RoundRectangle 4" Stroke="{StaticResource Border}" StrokeThickness="1" BackgroundColor="{StaticResource Surface}" Padding="0" Margin="4,0">
                                                <Entry Text="{Binding Description, Mode=TwoWay}"
                                                       Placeholder="Descripción del ítem"
                                                       PlaceholderColor="{StaticResource TextMuted}"
                                                       FontFamily="IBMPlexSans" FontSize="13"
                                                       BackgroundColor="Transparent" />
                                            </Border>
                                            <Border Grid.Column="2" StrokeShape="RoundRectangle 4" Stroke="{StaticResource Border}" StrokeThickness="1" BackgroundColor="{StaticResource Surface}" Padding="0">
                                                <Entry Text="{Binding UnitPrice, Mode=TwoWay}"
                                                       Placeholder="0"
                                                       PlaceholderColor="{StaticResource TextMuted}"
                                                       FontFamily="IBMPlexMono" FontSize="13"
                                                       HorizontalTextAlignment="End"
                                                       Keyboard="Numeric"
                                                       BackgroundColor="Transparent">
                                                    <Entry.Behaviors>
                                                        <behaviors:CurrencyInputBehavior />
                                                    </Entry.Behaviors>
                                                </Entry>
                                            </Border>
                                            <Label Grid.Column="3" Text="{Binding SubtotalFormatted}"
                                                   FontFamily="IBMPlexMono" FontSize="13"
                                                   TextColor="{StaticResource TextPrimary}"
                                                   HorizontalTextAlignment="End"
                                                   VerticalTextAlignment="Center"
                                                   Padding="4,0" />
                                            <Button Grid.Column="4" Text="×"
                                                    FontSize="16"
                                                    TextColor="{StaticResource TextMuted}"
                                                    BackgroundColor="Transparent"
                                                    Padding="0"
                                                    WidthRequest="30" HeightRequest="30"
                                                    MinimumHeightRequest="30"
                                                    MinimumWidthRequest="30"
                                                    CornerRadius="4"
                                                    CommandParameter="{Binding .}"
                                                    Clicked="OnDeleteItemClicked" />
                                        </Grid>
                                    </Border>
                                    <BoxView HeightRequest="1" Color="{StaticResource Border}" />
                                </VerticalStackLayout>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>

                    <!-- Add item button -->
                    <HorizontalStackLayout Padding="0,10,0,14">
                        <Button Text="+ Agregar ítem"
                                FontFamily="IBMPlexSansMedium"
                                FontSize="12"
                                TextColor="{StaticResource Blue}"
                                BackgroundColor="Transparent"
                                Padding="0"
                                MinimumHeightRequest="30"
                                Clicked="OnAddItemClicked" />
                    </HorizontalStackLayout>

                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <!-- ═══════════════════════════════════════════════ -->
        <!-- FOOTER                                          -->
        <!-- ═══════════════════════════════════════════════ -->
        <VerticalStackLayout Grid.Row="1" BackgroundColor="{StaticResource Surface}" Spacing="0">
            <BoxView HeightRequest="1" Color="{StaticResource Border}" />

            <!-- Total bar (dark) -->
            <Border StrokeShape="RoundRectangle 7"
                    StrokeThickness="0"
                    BackgroundColor="{StaticResource ToastBg}"
                    Margin="24,12,24,0"
                    Padding="18,12">
                <Grid ColumnDefinitions="*,Auto">
                    <Label Grid.Column="0"
                           Text="Total"
                           FontFamily="IBMPlexSansSemiBold" FontSize="15"
                           TextColor="{StaticResource White}"
                           VerticalTextAlignment="Center" />
                    <Label x:Name="TotalLabel"
                           Grid.Column="1"
                           Text="$49.000"
                           FontFamily="IBMPlexMonoSemiBold" FontSize="20"
                           TextColor="{StaticResource White}"
                           VerticalTextAlignment="Center" />
                </Grid>
            </Border>

            <!-- Action buttons -->
            <HorizontalStackLayout HorizontalOptions="End" Spacing="10" Padding="24,10">
                <Button Text="Cancelar"
                        FontFamily="IBMPlexSansMedium" FontSize="13"
                        TextColor="{StaticResource TextSecondary}"
                        BackgroundColor="{StaticResource Surface}"
                        BorderColor="{StaticResource Border}"
                        BorderWidth="1"
                        CornerRadius="8"
                        Padding="18,10"
                        Clicked="OnCancelClicked" />
                <Button Text="Confirmar factura"
                        FontFamily="IBMPlexSansSemiBold" FontSize="13"
                        TextColor="{StaticResource White}"
                        BackgroundColor="{StaticResource Blue}"
                        CornerRadius="8"
                        Padding="18,10"
                        Clicked="OnConfirmClicked" />
            </HorizontalStackLayout>
        </VerticalStackLayout>

    </Grid>

</ContentPage>
